<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Employee360 Widget</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    #container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      background: transparent;
    }
    #animated-content {
      width: 85%;
      height: 85%;
      border-radius: 50%;
      box-shadow: none;
      transition: box-shadow 0.2s;
      animation: pulse 2s ease-in-out infinite;
      overflow: visible;
      pointer-events: none;
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    #animated-content svg {
      pointer-events: none;
    }
    #container:hover #animated-content {
      box-shadow: none;
    }
    
    /* Notification badge */
    #notification-badge {
      position: absolute;
      top: 5%;
      right: 5%;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      animation: notification-pulse 1.5s ease-in-out infinite;
      z-index: 100;
    }
    
    #notification-badge.show {
      display: flex;
    }
    
    @keyframes notification-pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="animated-content">
      <svg id="animation-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="width: 70%; height: 70%;">
        <!-- Animations will be loaded here -->
      </svg>
    </div>
    <div id="notification-badge">0</div>
  </div>
  <style>
    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
    }
  </style>
  <script>
    console.log('Widget loaded!');
    const { shell, ipcRenderer } = require('electron');
    const container = document.getElementById('container');
    const animationSvg = document.getElementById('animation-svg');
    const notificationBadge = document.getElementById('notification-badge');
    
    // Notification management
    let notificationCount = 0;
    
    function updateNotification(count) {
      console.log('üîî updateNotification called with count:', count);
      notificationCount = count;
      if (count > 0) {
        notificationBadge.textContent = count > 99 ? '99+' : count;
        notificationBadge.classList.add('show');
        console.log('‚úÖ Badge shown with count:', notificationBadge.textContent);
      } else {
        notificationBadge.classList.remove('show');
        console.log('‚ùå Badge hidden (count is 0)');
      }
    }
    
    // Listen for notification updates
    ipcRenderer.on('show-notification', (event, count) => {
      updateNotification(count);
    });
    
    // Fetch notifications from dashboard (polling every 30 seconds)
    async function checkNotifications() {
      try {
        console.log('üîî Checking notifications from:', 'http://localhost:8001/api/notifications/unread-count');
        const response = await fetch('http://localhost:8001/api/notifications/unread-count');
        console.log('üì° Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('üìä Received data:', data);
          const unreadCount = data.count || 0;
          console.log('üéØ Unread notifications count:', unreadCount);
          updateNotification(unreadCount);
        } else {
          console.error('‚ùå Response not OK:', response.status, response.statusText);
        }
      } catch (error) {
        // Dashboard not available or no notifications endpoint
        console.error('‚ùå Error fetching notifications:', error);
      }
    }
    
    // Check notifications on load and every 5 seconds
    console.log('üöÄ Starting notification polling...');
    checkNotifications();
    setInterval(checkNotifications, 5000); // Check every 5 seconds for faster updates
    
    // Animation definitions
    const animations = {
      employee360: `
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <g class="employee360">
          <!-- Central circle with gradient -->
          <circle cx="50" cy="50" r="18" fill="none" stroke="white" stroke-width="2" opacity="0.3"/>
          
          <!-- Large "360" in center - crystal clear without blur -->
          <text x="50" y="59" font-size="28" font-weight="900" fill="white" text-anchor="middle" font-family="Arial, sans-serif" opacity="1" stroke="white" stroke-width="1">
            360
          </text>
          
          <!-- Rotating arc segments forming a complete circle -->
          <path d="M 50 15 A 35 35 0 0 1 85 50" fill="none" stroke="white" stroke-width="3" opacity="0.8" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/>
          </path>
          <path d="M 85 50 A 35 35 0 0 1 50 85" fill="none" stroke="white" stroke-width="3" opacity="0.6" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/>
          </path>
          <path d="M 50 85 A 35 35 0 0 1 15 50" fill="none" stroke="white" stroke-width="3" opacity="0.4" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/>
          </path>
          <path d="M 15 50 A 35 35 0 0 1 50 15" fill="none" stroke="white" stroke-width="3" opacity="0.2" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/>
          </path>
          
          <!-- Counter-rotating outer ring -->
          <circle cx="50" cy="50" r="40" fill="none" stroke="white" stroke-width="1" opacity="0" stroke-dasharray="3 5">
            <animate attributeName="opacity" values="0.3;0.6;0.3" dur="2s" repeatCount="indefinite"/>
            <animateTransform attributeName="transform" type="rotate" from="360 50 50" to="0 50 50" dur="4s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Three orbiting dots at different speeds -->
          <g opacity="0.9">
            <circle cx="50" cy="10" r="2.5" fill="white">
              <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite"/>
            </circle>
          </g>
          <g opacity="0.8">
            <circle cx="90" cy="50" r="2" fill="white">
              <animateTransform attributeName="transform" type="rotate" from="120 50 50" to="480 50 50" dur="3.5s" repeatCount="indefinite"/>
            </circle>
          </g>
          <g opacity="0.7">
            <circle cx="50" cy="90" r="2" fill="white">
              <animateTransform attributeName="transform" type="rotate" from="240 50 50" to="600 50 50" dur="4.5s" repeatCount="indefinite"/>
            </circle>
          </g>
          
          <!-- Subtle expanding ring -->
          <circle cx="50" cy="50" r="25" fill="none" stroke="white" stroke-width="1" opacity="0">
            <animate attributeName="r" values="25;42;25" dur="3s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.4;0;0.4" dur="3s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Small degree indicator -->
          <circle cx="50" cy="50" r="2" fill="white" opacity="0.6">
            <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
          </circle>
        </g>
      `,
      robot: `
        <g class="robot-face" style="animation: float 3s ease-in-out infinite;">
          <rect x="25" y="30" width="50" height="45" rx="8" fill="white" opacity="0.95"/>
          <circle cx="40" cy="50" r="5" fill="#667eea">
            <animate attributeName="r" values="5;3;5" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="60" cy="50" r="5" fill="#667eea">
            <animate attributeName="r" values="5;3;5" dur="2s" repeatCount="indefinite"/>
          </circle>
          <line x1="50" y1="30" x2="50" y2="20" stroke="white" stroke-width="2"/>
          <circle cx="50" cy="18" r="3" fill="white">
            <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
          </circle>
          <path d="M 38 62 Q 50 68 62 62" stroke="#667eea" stroke-width="2" fill="none"/>
          <line x1="30" y1="45" x2="35" y2="45" stroke="#764ba2" stroke-width="1" opacity="0.5"/>
          <line x1="65" y1="45" x2="70" y2="45" stroke="#764ba2" stroke-width="1" opacity="0.5"/>
        </g>
        <circle cx="30" cy="40" r="2" fill="white" opacity="0">
          <animate attributeName="cy" values="40;25;40" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="70" cy="40" r="2" fill="white" opacity="0">
          <animate attributeName="cy" values="40;25;40" dur="2s" begin="0.5s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;1;0" dur="2s" begin="0.5s" repeatCount="indefinite"/>
        </circle>
      `,
      lightning: `
        <g class="lightning">
          <path d="M 50 20 L 40 50 L 50 50 L 45 80" stroke="white" stroke-width="3" fill="none">
            <animate attributeName="opacity" values="0;1;0" dur="0.5s" repeatCount="indefinite"/>
          </path>
          <path d="M 50 20 L 40 50 L 50 50 L 45 80" stroke="white" stroke-width="6" fill="none" opacity="0.5">
            <animate attributeName="opacity" values="0;0.5;0" dur="0.5s" repeatCount="indefinite"/>
          </path>
          <circle cx="50" cy="20" r="3" fill="white">
            <animate attributeName="r" values="3;5;3" dur="0.5s" repeatCount="indefinite"/>
          </circle>
        </g>
      `,
      heartbeat: `
        <defs>
          <radialGradient id="heartGradient" cx="50%" cy="50%">
            <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ff0000;stop-opacity:0.9" />
          </radialGradient>
        </defs>
        <g class="heartbeat">
          <!-- Main heart shape with realistic beat -->
          <path d="M 50 70 C 50 70, 30 50, 30 40 C 30 30, 40 25, 50 35 C 60 25, 70 30, 70 40 C 70 50, 50 70, 50 70 Z" 
                fill="url(#heartGradient)" 
                opacity="1"
                transform-origin="50 45">
            <animateTransform 
              attributeName="transform" 
              type="scale" 
              values="1;1.15;1;1.08;1" 
              dur="1.2s" 
              repeatCount="indefinite"/>
            <animate attributeName="opacity" values="1;0.85;1;0.9;1" dur="1.2s" repeatCount="indefinite"/>
          </path>
        </g>
      `,
      radar: `
        <g class="radar">
          <!-- Radar circles -->
          <circle cx="50" cy="50" r="35" stroke="white" stroke-width="1" fill="none" opacity="0.3"/>
          <circle cx="50" cy="50" r="25" stroke="white" stroke-width="1" fill="none" opacity="0.4"/>
          <circle cx="50" cy="50" r="15" stroke="white" stroke-width="1" fill="none" opacity="0.5"/>
          
          <!-- Scanning line -->
          <line x1="50" y1="50" x2="50" y2="15" stroke="white" stroke-width="2" opacity="0.8">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2s" repeatCount="indefinite"/>
          </line>
          
          <!-- Scanning gradient effect -->
          <path d="M 50 50 L 50 15 A 35 35 0 0 1 85 50 Z" fill="white" opacity="0.2">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2s" repeatCount="indefinite"/>
          </path>
          
          <!-- Blinking dots at different positions -->
          <circle cx="65" cy="35" r="2" fill="white">
            <animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="35" cy="60" r="2" fill="white">
            <animate attributeName="opacity" values="0;1;0" dur="2s" begin="0.5s" repeatCount="indefinite"/>
          </circle>
          <circle cx="70" cy="65" r="2" fill="white">
            <animate attributeName="opacity" values="0;1;0" dur="2s" begin="1s" repeatCount="indefinite"/>
          </circle>
        </g>
      `,
      stars: `
        <g class="stars">
          <path d="M 50 25 L 52 35 L 62 35 L 54 42 L 57 52 L 50 45 L 43 52 L 46 42 L 38 35 L 48 35 Z" fill="white" opacity="0.8">
            <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.8;1;0.8" dur="1.5s" repeatCount="indefinite"/>
          </path>
          <circle cx="30" cy="30" r="2" fill="white">
            <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" repeatCount="indefinite"/>
          </circle>
          <circle cx="70" cy="30" r="2" fill="white">
            <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" begin="0.3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="30" cy="70" r="2" fill="white">
            <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" begin="0.6s" repeatCount="indefinite"/>
          </circle>
          <circle cx="70" cy="70" r="2" fill="white">
            <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" begin="0.9s" repeatCount="indefinite"/>
          </circle>
        </g>
      `
    };
    
    // Set animation
    function setAnimation(type) {
      if (animations[type]) {
        animationSvg.innerHTML = animations[type];
      }
    }
    
    // Request saved animation from main process
    ipcRenderer.send('get-saved-animation');
    
    // Load saved animation when received
    ipcRenderer.on('load-animation', (event, animationType) => {
      setAnimation(animationType || 'employee360');
    });
    
    // Listen for animation changes
    ipcRenderer.on('set-animation', (event, animationType) => {
      setAnimation(animationType);
    });
    
    console.log('Container:', container);
    
    let isDragging = false;
    let dragTimer = null;
    
    // Right-click to show animation menu
    container.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      ipcRenderer.send('show-animation-menu');
    });
    
    // Drag functionality
    container.addEventListener('mousedown', (e) => {
      if (e.button === 0) { // Left click only
        isDragging = false;
        
        // Start a timer - if mouse moves before timer expires, it's a drag
        dragTimer = setTimeout(() => {
          dragTimer = null;
        }, 200);
        
        // Listen for mouse move to detect drag
        const onMouseMove = (moveEvent) => {
          if (dragTimer) {
            clearTimeout(dragTimer);
            dragTimer = null;
          }
          isDragging = true;
          ipcRenderer.send('start-drag');
          document.removeEventListener('mousemove', onMouseMove);
          
          // Continue dragging
          const onDrag = () => {
            ipcRenderer.send('dragging');
          };
          
          const onMouseUp = () => {
            ipcRenderer.send('end-drag');
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', onMouseUp);
            
            // If barely moved, count as click
            setTimeout(() => {
              isDragging = false;
            }, 50);
          };
          
          document.addEventListener('mousemove', onDrag);
          document.addEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        
        // Handle mouseup without moving (click)
        const onMouseUpNoMove = () => {
          if (dragTimer) {
            clearTimeout(dragTimer);
            dragTimer = null;
          }
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUpNoMove);
        };
        
        document.addEventListener('mouseup', onMouseUpNoMove);
      }
    });
    
    container.addEventListener('click', (e) => {
      if (!isDragging) {
        console.log('Opening dashboard...');
        shell.openExternal('http://localhost:3000').then(() => {
          console.log('Dashboard opened successfully');
        }).catch(err => {
          console.error('Failed to open dashboard:', err);
        });
      }
    });
  </script>
</body>
</html>
